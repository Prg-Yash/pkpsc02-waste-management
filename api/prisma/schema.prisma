// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
  output   = "./generated/prisma"
}

enum WasteStatus {
  PENDING
  IN_PROGRESS
  COLLECTED
}

enum NotificationType {
  WASTE_REPORTED
  WASTE_COLLECTED
  COLLECTOR_ENABLED
  BID_PLACED
  AUCTION_WON
  AUCTION_ENDED
}

enum ListingStatus {
  ACTIVE
  ENDED
  COMPLETED
  CANCELLED
}

enum UserStatus {
  ACTIVE
  FLAGGED
  BANNED
}

model User {
  id                       String  @id
  email                    String  @unique
  name                     String?
  phone                    String?
  phoneVerified            Boolean @default(false)
  whatsappMessagingEnabled Boolean @default(false)
  enableCollector          Boolean @default(false)

  city    String?
  state   String?
  country String?

  reporterPoints  Int @default(0)
  collectorPoints Int @default(0)
  globalPoints    Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reportedWastes    WasteReport[]  @relation("UserReportedWastes")
  collectedWastes   WasteReport[]  @relation("UserCollectedWastes")
  routePlannerWaste WasteReport[]  @relation("RoutePlannerCollector")
  notifications     Notification[]
  phoneOTPs         PhoneOTP[]
  
  // Marketplace relations
  listings          MarketplaceListing[] @relation("UserListings")
  bids              Bid[]                @relation("UserBids")
  wonListings       MarketplaceListing[] @relation("WinnerListings")

  @@index([globalPoints, reporterPoints, collectorPoints])
}

model WasteReport {
  id String @id @default(cuid())

  reporterId String
  reporter   User   @relation("UserReportedWastes", fields: [reporterId], references: [id])

  collectorId String?
  collector   User?   @relation("UserCollectedWastes", fields: [collectorId], references: [id])

  routeCollectorId String?
  routeCollector   User?   @relation("RoutePlannerCollector", fields: [routeCollectorId], references: [id])

  imageUrl          String
  collectorImageUrl String?

  locationRaw      String
  isLocationLatLng Boolean @default(false)
  latitude         Float?
  longitude        Float?
  city             String?
  state            String?
  country          String?

  // AI Analysis Data (JSON format)
  // Contains: wasteType, confidence, estimatedWeightKg, notes, category
  // + category-specific fields (segregation, recyclability, etc.)
  aiAnalysis Json?

  status WasteStatus @default(PENDING)

  reportedAt  DateTime  @default(now())
  collectedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  type  NotificationType
  title String
  body  String
  data  Json?
  read  Boolean          @default(false)

  createdAt DateTime @default(now())
}

model PhoneOTP {
  id        String   @id @default(cuid())
  userId    String
  otpHash   String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

model MarketplaceListing {
  id String @id @default(cuid())

  sellerId String
  seller   User   @relation("UserListings", fields: [sellerId], references: [id])

  winnerId String?
  winner   User?   @relation("WinnerListings", fields: [winnerId], references: [id])

  // Listing details
  wasteType   String
  weightKg    Float
  description String?
  basePrice   Float

  // Images (JSON array of S3 URLs)
  images Json

  // Location
  latitude  Float
  longitude Float
  city      String?
  state     String?

  // Auction details
  auctionDuration Int      @default(60) // in minutes
  auctionEndTime  DateTime
  status          ListingStatus @default(ACTIVE)

  // Current highest bid
  highestBid Float?

  // QR code for verification (generated when auction ends)
  verificationCode String? @unique

  // Completion
  completedAt DateTime?
  verifiedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bids Bid[]

  @@index([status, auctionEndTime])
  @@index([sellerId])
}

model Bid {
  id String @id @default(cuid())

  listingId String
  listing   MarketplaceListing @relation(fields: [listingId], references: [id])

  bidderId String
  bidder   User   @relation("UserBids", fields: [bidderId], references: [id])

  amount    Float
  createdAt DateTime @default(now())

  @@index([listingId, amount])
  @@index([bidderId])
}
